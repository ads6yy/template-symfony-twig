name: QA Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
    steps:
      - uses: actions/checkout@v4
      - run: echo "Cache key set"

  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: jakzal/phpqa:php8.3
    steps:
      - uses: actions/checkout@v4

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: vendor/
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHPStan (GitLab format)
        continue-on-error: true
        run: vendor/bin/phpstan analyse --memory-limit=1G --error-format=gitlab > phpstan-report.json || true

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G

      - name: Upload PHPStan report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: phpstan-report
          path: phpstan-report.json

  php-cs-fixer:
    name: PHP-CS-Fixer
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: jakzal/phpqa:php8.3
    steps:
      - uses: actions/checkout@v4

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: vendor/
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHP-CS-Fixer (GitLab format)
        continue-on-error: true
        run: vendor/bin/php-cs-fixer fix --dry-run --format=gitlab > php-cs-fixer-report.json || true

      - name: Run PHP-CS-Fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff --verbose --ansi

      - name: Upload PHP-CS-Fixer report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: php-cs-fixer-report
          path: php-cs-fixer-report.json

  security-checker:
    name: Security Checker
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: jakzal/phpqa:php8.3
    steps:
      - uses: actions/checkout@v4

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: vendor/
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run Composer audit
        run: composer audit

  phpmd:
    name: PHPMD
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: jakzal/phpqa:php8.3
    steps:
      - uses: actions/checkout@v4

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: vendor/
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHPMD
        run: vendor/bin/phpmd src ansi phpmd.xml

  phpcpd:
    name: PHPCPD
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: jakzal/phpqa:php8.3
    steps:
      - uses: actions/checkout@v4

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: vendor/
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHPCPD
        run: vendor/bin/phpcpd src --verbose

  qa-summary:
    name: QA Summary
    runs-on: ubuntu-latest
    needs: [ phpstan, php-cs-fixer, security-checker, phpmd, phpcpd ]
    if: always()
    steps:
      - name: Check QA Results
        run: |
          echo "## QA Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ PHPStan: ${{ needs.phpstan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ PHP-CS-Fixer: ${{ needs.php-cs-fixer.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security Checker: ${{ needs.security-checker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ PHPMD: ${{ needs.phpmd.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ PHPCPD: ${{ needs.phpcpd.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.phpstan.result }}" != "success" ] || \
             [ "${{ needs.php-cs-fixer.result }}" != "success" ] || \
             [ "${{ needs.security-checker.result }}" != "success" ] || \
             [ "${{ needs.phpmd.result }}" != "success" ] || \
             [ "${{ needs.phpcpd.result }}" != "success" ]; then
            exit 1
          fi